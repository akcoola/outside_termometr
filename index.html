<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è –ö–∞–∑–∞–Ω–∫–∞</title>
    <meta name="theme-color" content="#0a192f">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            color: #e6f1ff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(17, 34, 64, 0.7);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #64ffda, #57cbff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .config-form {
            background: rgba(17, 34, 64, 0.9);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        .config-form h2 {
            color: #64ffda;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #8892b0;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(10, 25, 47, 0.5);
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 10px;
            color: #e6f1ff;
            font-size: 1rem;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #64ffda, #57cbff);
            color: #0a192f;
        }

        .btn-secondary {
            background: transparent;
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(100, 255, 218, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .temperature-panel {
            background: rgba(17, 34, 64, 0.7);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 255, 218, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .temperature-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .temp-value {
            font-size: 6rem;
            font-weight: 800;
            background: linear-gradient(90deg, #64ffda, #57cbff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            margin-bottom: 20px;
        }

        .temp-unit {
            font-size: 3rem;
            opacity: 0.7;
            vertical-align: top;
        }

        .temp-status {
            font-size: 1.8rem;
            color: #64ffda;
            margin-bottom: 5px;
        }

        .temp-meta {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }

        .temp-meta-item {
            text-align: center;
        }

        .meta-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #57cbff;
        }

        .info-panel {
            background: rgba(17, 34, 64, 0.7);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 255, 218, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(10, 25, 47, 0.5);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(100, 255, 218, 0.1);
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #64ffda;
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #64ffda;
        }

        .chart-container {
            height: 250px;
            background: rgba(10, 25, 47, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-title {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        .interval-select {
            background: rgba(10, 25, 47, 0.8);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            min-width: 120px;
        }

        #temperatureChart {
            width: 100%;
            height: calc(100% - 40px);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .action-btn {
            padding: 15px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #0a192f, #112240);
            color: #64ffda;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid rgba(100, 255, 218, 0.3);
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #112240, #0a192f);
            border-color: #64ffda;
            transform: translateY(-3px);
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .connected {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.5);
            color: #2ecc71;
        }

        .disconnected {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
        }

        .last-update {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .temp-value {
                font-size: 4rem;
            }
            
            .temp-unit {
                font-size: 2rem;
            }
            
            .temp-status {
                font-size: 1.4rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .config-form {
                padding: 20px;
            }
            
            .temp-meta {
                flex-direction: column;
                gap: 15px;
            }
            
            .chart-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .interval-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="configOverlay" class="config-overlay">
        <div class="config-form">
            <h2><i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ThingSpeak</h2>
            <p style="color: #8892b0; margin-bottom: 25px; text-align: center;">
                –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–∞—à–µ–º—É –∫–∞–Ω–∞–ª—É ThingSpeak
            </p>
            
            <div class="form-group">
                <label for="channelId"><i class="fas fa-hashtag"></i> Channel ID</label>
                <input type="text" id="channelId" placeholder="–í–≤–µ–¥–∏—Ç–µ Channel ID">
            </div>
            
            <div class="form-group">
                <label for="apiKey"><i class="fas fa-key"></i> Read API Key</label>
                <input type="text" id="apiKey" placeholder="–í–≤–µ–¥–∏—Ç–µ Read API Key">
            </div>
            
            <div class="form-group">
                <label for="fieldNumber"><i class="fas fa-sort-numeric-up"></i> –ù–æ–º–µ—Ä –ø–æ–ª—è</label>
                <input type="number" id="fieldNumber" value="3" min="1" max="8">
                <small style="color: #8892b0; font-size: 0.8rem;">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è field3</small>
            </div>
            
            <div class="form-buttons">
                <button type="button" class="btn btn-secondary" id="cancelBtn">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-temperature-high"></i> –ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è –ö–∞–∑–∞–Ω–∫–∞</h1>
        </header>

        <div class="main-content">
            <div class="temperature-panel">
                <div class="temperature-display">
                    <div class="temp-value">
                        <span id="tempValue">--</span><span class="temp-unit">¬∞C</span>
                    </div>
                    <div class="temp-status" id="tempStatus">
                        <i class="fas fa-thermometer-half"></i> <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ThingSpeak...</span>
                    </div>
                    
                    <div class="temp-meta">
                        <div class="temp-meta-item">
                            <div class="meta-label">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>
                            <div class="meta-value" id="humidityValue">--%</div>
                        </div>
                        <div class="temp-meta-item">
                            <div class="meta-label">–î–∞–≤–ª–µ–Ω–∏–µ</div>
                            <div class="meta-value" id="pressureValue">-- hPa</div>
                        </div>
                        <div class="temp-meta-item">
                            <div class="meta-label">–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                            <div class="meta-value" id="updateTime">--:--</div>
                        </div>
                    </div>
                </div>
                
                <div class="last-update" id="lastUpdate">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>

            <div class="info-panel">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-temperature-low"></i> –ú–∏–Ω. –∑–∞ —Å—É—Ç–∫–∏
                        </div>
                        <div class="stat-value" id="minTemp">--¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-temperature-high"></i> –ú–∞–∫—Å. –∑–∞ —Å—É—Ç–∫–∏
                        </div>
                        <div class="stat-value" id="maxTemp">--¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-chart-line"></i> –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —á–∞—Å
                        </div>
                        <div class="stat-value" id="tempChange">--¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-trend-up"></i> –¢–µ–Ω–¥–µ–Ω—Ü–∏—è
                        </div>
                        <div class="stat-value" id="tempTrend">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-arrows-alt-v"></i> –î–µ–ª—å—Ç–∞ (–º–∏–Ω-–º–∞–∫—Å)
                        </div>
                        <div class="stat-value" id="tempRange">--¬∞C</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <i class="fas fa-clock"></i> –°—Ä–µ–¥–Ω—è—è –∑–∞ –¥–µ–Ω—å
                        </div>
                        <div class="stat-value" id="avgTemp">--¬∞C</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-controls">
                        <div class="chart-title">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
                        <select id="intervalSelect" class="interval-select">
                            <option value="0.25">15 –º–∏–Ω</option>
                            <option value="0.5">30 –º–∏–Ω</option>
                            <option value="1">1 —á–∞—Å</option>
                            <option value="6">6 —á–∞—Å–æ–≤</option>
                            <option value="24">24 —á–∞—Å–∞</option>
                            <option value="72">3 –¥–Ω—è</option>
                        </select>
                    </div>
                    <canvas id="temperatureChart"></canvas>
                </div>

                <div class="action-buttons">
                    <button class="action-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button class="action-btn" id="settingsBtn">
                        <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                    <button class="action-btn" id="saveCodeBtn">
                        <i class="fas fa-download"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-plug"></i>
        <span>–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentTemp = null;
        let config = {
            channelId: '',
            apiKey: '',
            fieldNumber: 3
        };
        let isConnected = false;
        let lastUpdateTime = null;
        let selectedInterval = 24;
        let tempChart;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const configOverlay = document.getElementById('configOverlay');
        const channelIdInput = document.getElementById('channelId');
        const apiKeyInput = document.getElementById('apiKey');
        const fieldNumberInput = document.getElementById('fieldNumber');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const tempValue = document.getElementById('tempValue');
        const tempStatus = document.getElementById('tempStatus');
        const minTempEl = document.getElementById('minTemp');
        const maxTempEl = document.getElementById('maxTemp');
        const tempChangeEl = document.getElementById('tempChange');
        const tempTrendEl = document.getElementById('tempTrend');
        const tempRangeEl = document.getElementById('tempRange');
        const avgTempEl = document.getElementById('avgTemp');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveCodeBtn = document.getElementById('saveCodeBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const humidityValue = document.getElementById('humidityValue');
        const pressureValue = document.getElementById('pressureValue');
        const updateTime = document.getElementById('updateTime');
        const lastUpdate = document.getElementById('lastUpdate');
        const intervalSelect = document.getElementById('intervalSelect');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function initChart() {
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ¬∞C',
                        data: [],
                        borderColor: '#64ffda',
                        backgroundColor: 'rgba(100, 255, 218, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'dd.MM HH:mm'
                            },
                            ticks: { color: '#8892b0' },
                            grid: { color: 'rgba(100, 255, 218, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#8892b0',
                                callback: function(value) { return value + '¬∞C'; }
                            },
                            grid: { color: 'rgba(100, 255, 218, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function loadConfig() {
            const savedConfig = localStorage.getItem('thermometerConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                channelIdInput.value = config.channelId;
                apiKeyInput.value = config.apiKey;
                fieldNumberInput.value = config.fieldNumber;
                return true;
            }
            return false;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        function loadInterval() {
            const savedInterval = localStorage.getItem('chartInterval');
            if (savedInterval) {
                selectedInterval = parseFloat(savedInterval);
                intervalSelect.value = selectedInterval;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        function saveInterval() {
            selectedInterval = parseFloat(intervalSelect.value);
            localStorage.setItem('chartInterval', selectedInterval);
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function saveConfig() {
            config = {
                channelId: channelIdInput.value.trim(),
                apiKey: apiKeyInput.value.trim(),
                fieldNumber: parseInt(fieldNumberInput.value) || 3
            };
            
            if (!config.channelId || !config.apiKey) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            localStorage.setItem('thermometerConfig', JSON.stringify(config));
            configOverlay.style.display = 'none';
            fetchTemperature();
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        async function fetchTemperature() {
            if (!config.channelId || !config.apiKey) {
                showConfigForm();
                return;
            }
            
            try {
                updateConnectionStatus(false, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                
                const lastUrl = `https://api.thingspeak.com/channels/${config.channelId}/fields/${config.fieldNumber}/last.json?api_key=${config.apiKey}`;
                const lastResponse = await fetch(lastUrl);
                
                if (!lastResponse.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                
                const lastData = await lastResponse.json();
                
                if (lastData[`field${config.fieldNumber}`] === null) {
                    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª–µ');
                }
                
                currentTemp = parseFloat(lastData[`field${config.fieldNumber}`]);
                lastUpdateTime = new Date();
                isConnected = true;
                updateConnectionStatus(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                updateDisplay(currentTemp);
                updateTimeDisplay();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (24 —á–∞—Å–∞) –∏ –≥—Ä–∞—Ñ–∏–∫–∞
                await fetchDataForStats();
                await fetchDataForGraph();
                
                updateTempStatus(currentTemp);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                isConnected = false;
                updateConnectionStatus(false, '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                
                if (!currentTemp) {
                    currentTemp = 20 + (Math.random() - 0.5) * 10;
                    updateDisplay(currentTemp);
                    updateTempStatus(currentTemp);
                }
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (24 —á–∞—Å–∞)
        async function fetchDataForStats() {
            try {
                const url = `https://api.thingspeak.com/channels/${config.channelId}/fields/${config.fieldNumber}.json?results=1440&api_key=${config.apiKey}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.feeds || data.feeds.length === 0) {
                    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ 24 —á–∞—Å–∞');
                    return;
                }

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                const temperatures = [];
                let lastValidTemp = null;
                let lastTime = null;

                for (const feed of data.feeds) {
                    const temp = parseFloat(feed[`field${config.fieldNumber}`]);
                    if (isNaN(temp)) continue;

                    const time = new Date(feed.created_at).getTime();
                    
                    if (lastValidTemp !== null && lastTime !== null) {
                        const timeDiff = time - lastTime;
                        const maxTimeGap = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
                        const maxTempGap = 3; // 3¬∞C
                        
                        if (timeDiff > maxTimeGap || Math.abs(temp - lastValidTemp) > maxTempGap) {
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                            temperatures.push(lastValidTemp);
                        } else {
                            temperatures.push(temp);
                            lastValidTemp = temp;
                        }
                    } else {
                        temperatures.push(temp);
                        lastValidTemp = temp;
                    }
                    
                    lastTime = time;
                }

                if (temperatures.length > 0) {
                    updateStats(temperatures);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ (–≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª)
        async function fetchDataForGraph() {
            try {
                const hours = selectedInterval;
                const results = Math.min(hours * 60, 8000);
                const url = `https://api.thingspeak.com/channels/${config.channelId}/fields/${config.fieldNumber}.json?results=${results}&api_key=${config.apiKey}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.feeds || data.feeds.length === 0) {
                    console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
                    return;
                }

                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                const chartData = [];
                let lastValidTemp = null;
                let lastTime = null;
                const cutoffTime = new Date().getTime() - (hours * 60 * 60 * 1000);

                for (const feed of data.feeds) {
                    const temp = parseFloat(feed[`field${config.fieldNumber}`]);
                    if (isNaN(temp)) continue;

                    const time = new Date(feed.created_at).getTime();
                    
                    if (time < cutoffTime) continue;
                    
                    if (lastValidTemp !== null && lastTime !== null) {
                        const timeDiff = time - lastTime;
                        const maxTimeGap = 5 * 60 * 1000;
                        const maxTempGap = 3;
                        
                        if (timeDiff > maxTimeGap || Math.abs(temp - lastValidTemp) > maxTempGap) {
                            chartData.push({ x: new Date(time), y: lastValidTemp });
                        } else {
                            chartData.push({ x: new Date(time), y: temp });
                            lastValidTemp = temp;
                        }
                    } else {
                        chartData.push({ x: new Date(time), y: temp });
                        lastValidTemp = temp;
                    }
                    
                    lastTime = time;
                }

                if (chartData.length > 0) {
                    updateChart(chartData);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        function updateDisplay(temp) {
            tempValue.textContent = temp.toFixed(1);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
        function updateTempStatus(temp) {
            let statusText = '–ù–æ—Ä–º–∞';
            let statusIcon = 'üòä';
            
            if (temp < -20) {
                statusText = '–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–π –º–æ—Ä–æ–∑';
                statusIcon = 'ü•∂';
            } else if (temp < -10) {
                statusText = '–°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ–∑';
                statusIcon = '‚ùÑÔ∏è';
            } else if (temp < 0) {
                statusText = '–ú–æ—Ä–æ–∑';
                statusIcon = 'üå®';
            } else if (temp < 10) {
                statusText = '–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ';
                statusIcon = 'üçÉ';
            } else if (temp < 20) {
                statusText = '–ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ';
                statusIcon = 'üòä';
            } else if (temp < 30) {
                statusText = '–¢–µ–ø–ª–æ';
                statusIcon = '‚òÄÔ∏è';
            } else {
                statusText = '–ñ–∞—Ä–∫–æ';
                statusIcon = 'üî•';
            }
            
            tempStatus.innerHTML = `${statusIcon} ${statusText}`;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart(points) {
            if (!points || points.length === 0) return;
            
            tempChart.data.datasets[0].data = points;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
            let timeUnit = 'hour';
            if (selectedInterval > 24) timeUnit = 'day';
            
            tempChart.options.scales.x.time.unit = timeUnit;
            tempChart.update();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(temperatures) {
            if (!temperatures || temperatures.length === 0) return;
            
            // –ú–∏–Ω/–º–∞–∫—Å –∑–∞ —Å—É—Ç–∫–∏
            const minTemp = Math.min(...temperatures);
            const maxTemp = Math.max(...temperatures);
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ —á–∞—Å
            let hourChange = 0;
            if (temperatures.length > 60) {
                hourChange = temperatures[temperatures.length - 1] - temperatures[temperatures.length - 61];
            }
            
            // –î–µ–ª—å—Ç–∞ –∏ —Å—Ä–µ–¥–Ω—è—è
            const delta = maxTemp - minTemp;
            const avgTemp = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
            
            // –¢–µ–Ω–¥–µ–Ω—Ü–∏—è
            let trend = '–°—Ç–∞–±–∏–ª—å–Ω–æ';
            let trendIcon = '=';
            if (hourChange > 0.5) {
                trend = '–†–∞—Å—Ç—ë—Ç';
                trendIcon = '‚Üó';
            } else if (hourChange < -0.5) {
                trend = '–ü–∞–¥–∞–µ—Ç';
                trendIcon = '‚Üò';
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM
            minTempEl.textContent = `${minTemp.toFixed(1)}¬∞C`;
            maxTempEl.textContent = `${maxTemp.toFixed(1)}¬∞C`;
            tempChangeEl.textContent = `${hourChange >= 0 ? '+' : ''}${hourChange.toFixed(1)}¬∞C`;
            tempChangeEl.style.color = hourChange >= 0 ? '#2ecc71' : '#e74c3c';
            tempTrendEl.innerHTML = `${trendIcon} ${trend}`;
            tempRangeEl.textContent = `${delta.toFixed(1)}¬∞C`;
            avgTempEl.textContent = `${avgTemp.toFixed(1)}¬∞C`;
            
            // –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ
            humidityValue.textContent = `${Math.round(40 + Math.random() * 40)}%`;
            pressureValue.textContent = `${Math.round(980 + Math.random() * 40)} hPa`;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π
            tempTrendEl.previousElementSibling.textContent = '–¢–µ–Ω–¥–µ–Ω—Ü–∏—è –∑–∞ —á–∞—Å';
            avgTempEl.previousElementSibling.textContent = '–°—Ä–µ–¥–Ω—è—è –∑–∞ —Å—É—Ç–∫–∏';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTimeDisplay() {
            if (lastUpdateTime) {
                const timeStr = lastUpdateTime.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                updateTime.textContent = timeStr;
                
                const diff = Math.floor((new Date() - lastUpdateTime) / 1000);
                let timeAgo;
                
                if (diff < 60) {
                    timeAgo = `${diff} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
                } else if (diff < 3600) {
                    timeAgo = `${Math.floor(diff / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                } else {
                    timeAgo = `${Math.floor(diff / 3600)} —á –Ω–∞–∑–∞–¥`;
                }
                
                lastUpdate.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${timeAgo}`;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(connected, message) {
            isConnected = connected;
            connectionStatus.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
            connectionStatus.innerHTML = `<i class="fas fa-${connected ? 'plug' : 'plug'}"></i> <span>${message}</span>`;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function showConfigForm() {
            configOverlay.style.display = 'flex';
        }
        function hideConfigForm() {
            configOverlay.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ —Ñ–∞–π–ª
        function saveCodeToFile() {
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π HTML –∫–æ–¥
            const fullHTML = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è –ö–∞–∑–∞–Ω–∫–∞</title>
    <meta name="theme-color" content="#0a192f">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ${document.querySelector('style').textContent}
    </style>
</head>
<body>
    ${document.body.innerHTML}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"><\/script>
    <script>
        ${document.querySelector('script').textContent}
    <\/script>
</body>
</html>`;
            
            // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meteo_kazanka.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('–ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª meteo_kazanka.html');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            initChart();
            loadInterval();
            
            if (!loadConfig()) {
                showConfigForm();
            } else {
                fetchTemperature();
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            saveConfigBtn.addEventListener('click', saveConfig);
            cancelBtn.addEventListener('click', hideConfigForm);
            settingsBtn.addEventListener('click', showConfigForm);
            refreshBtn.addEventListener('click', fetchTemperature);
            saveCodeBtn.addEventListener('click', saveCodeToFile);
            
            intervalSelect.addEventListener('change', function() {
                saveInterval();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≥—Ä–∞—Ñ–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                if (config.channelId && config.apiKey) {
                    fetchDataForGraph();
                }
            });
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            setInterval(() => {
                if (isConnected) {
                    fetchTemperature();
                }
            }, 30000);
            
            setInterval(updateTimeDisplay, 1000);
        }
        
        // –ó–∞–ø—É—Å–∫
        window.addEventListener('load', initApp);
    </script>
</body>
</html>